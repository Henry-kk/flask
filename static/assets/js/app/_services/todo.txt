This needs refactoring, and deep logic restructuring